

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nichefinder — Simulated Data Tutorial &mdash; nichefinder 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="nichefinder — Niche Score Mapping" href="niche_score_mapping.html" />
    <link rel="prev" title="Installation" href="../installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            nichefinder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">nichefinder — Simulated Data Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-example-data">1. Load Example Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#visualise-cell-type-layout">Visualise cell-type layout</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#build-spatial-knn-graph">2. Build Spatial kNN Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="#aggregate-neighbourhood-compositions">3. Aggregate Neighbourhood Compositions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#find-niches-nmf">4. Find Niches (NMF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualise-spatial-niches">5. Visualise Spatial Niches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#aggregated-interactions-niche-overlay">Aggregated interactions + niche overlay</a></li>
<li class="toctree-l3"><a class="reference internal" href="#niche-bipartite-graph">Niche bipartite graph</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="niche_score_mapping.html">nichefinder — Niche Score Mapping</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/gene_selection.html">Gene Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/label_transfer.html">Label Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/niche_analysis.html">Niche Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nichefinder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">nichefinder — Simulated Data Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/example_simulated_data.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nichefinder-simulated-data-tutorial">
<h1>nichefinder — Simulated Data Tutorial<a class="headerlink" href="#nichefinder-simulated-data-tutorial" title="Link to this heading"></a></h1>
<p>This notebook demonstrates the <strong>nichefinder</strong> workflow on a small simulated
spatial transcriptomics dataset (the <em>fig2c</em> benchmark from the NiCo
paper[1]). The data contain ~1200 simulated cells distributed across 6
ground-truth cell-type niches (T0–T5).</p>
<p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p>Load spatial coordinates and cell-type labels from CSV files</p></li>
<li><p>Build a spatial kNN graph</p></li>
<li><p>Aggregate neighbourhood cell-type compositions</p></li>
<li><p>Discover niches with NMF</p></li>
<li><p>Visualise results</p></li>
</ol>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Add the repo root so the local nichefinder package is importable when running</span>
<span class="c1"># the notebook outside of an installed environment.</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()))</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nichefinder</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nf</span>

<span class="n">sc</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># warnings / errors</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-example-data">
<h2>1. Load Example Data<a class="headerlink" href="#load-example-data" title="Link to this heading"></a></h2>
<p>Two CSV files are stored in <code class="docutils literal notranslate"><span class="pre">tests/data/</span></code>. Each integer label maps to a named cell type T0–T5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../tests/data&quot;</span><span class="p">)</span>

<span class="c1"># Spatial coordinates (index = cell barcode, columns = x, y)</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;tissue_positions_list.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">positions</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>

<span class="c1"># Cell-type integer labels</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;save_clusterid_0.csv&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">positions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cells: 1200
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>x</th>
      <th>y</th>
    </tr>
    <tr>
      <th>0</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cell0</th>
      <td>-47.1687</td>
      <td>-48.4782</td>
    </tr>
    <tr>
      <th>cell1</th>
      <td>-40.9566</td>
      <td>47.6542</td>
    </tr>
    <tr>
      <th>cell2</th>
      <td>-33.1988</td>
      <td>49.7143</td>
    </tr>
    <tr>
      <th>cell3</th>
      <td>-31.2584</td>
      <td>-49.0793</td>
    </tr>
    <tr>
      <th>cell4</th>
      <td>-29.8418</td>
      <td>46.9326</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Build an AnnData object from the simulated data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="n">ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;T</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="n">ad</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 1200 × 2
    obs: &#39;cell_type&#39;
    obsm: &#39;spatial&#39;
</pre></div>
</div>
</div>
</div>
<p>Because we have added cell type labels manually and <code class="docutils literal notranslate"><span class="pre">nf.aggregate_neighbors</span></code> reads cell-type probabilities from <code class="docutils literal notranslate"><span class="pre">ad.obsm</span></code> and
looks up the key and label names via <code class="docutils literal notranslate"><span class="pre">ad.uns[&quot;label_transfer&quot;]</span></code>, we add this information to <code class="docutils literal notranslate"><span class="pre">ad.uns</span></code> manually, too. Here, because the ground-truth labels are known exactly, we use one-hot
encoded indicator vectors as (hard) “probabilities”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_type_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">])</span>
<span class="n">cell_type_labels</span> <span class="o">=</span> <span class="n">cell_type_dummies</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;cell_type_prob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_type_dummies</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Populate the label_transfer metadata expected by nf.aggregate_neighbors</span>
<span class="n">ad</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;label_transfer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cell_type&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;obsm_key&quot;</span><span class="p">:</span> <span class="s2">&quot;cell_type_prob&quot;</span><span class="p">,</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">cell_type_labels</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;genes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;external&quot;</span><span class="p">,</span>   <span class="c1"># probabilities provided externally (not from model)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell types:&quot;</span><span class="p">,</span> <span class="n">cell_type_labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell_type_prob shape:&quot;</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;cell_type_prob&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cell types: [&#39;T0&#39;, &#39;T1&#39;, &#39;T2&#39;, &#39;T3&#39;, &#39;T4&#39;, &#39;T5&#39;]
cell_type_prob shape: (1200, 6)
</pre></div>
</div>
</div>
</div>
<section id="visualise-cell-type-layout">
<h3>Visualise cell-type layout<a class="headerlink" href="#visualise-cell-type-layout" title="Link to this heading"></a></h3>
<p>Let’s inspect the spatial distribution of each cell type before running the
niche analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span>
    <span class="n">ad</span><span class="p">,</span>
    <span class="n">basis</span><span class="o">=</span><span class="s2">&quot;spatial&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Ground-truth cell types&quot;</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7a383254dd5518918dfec66d74275441e64561a99a530e4ceaedc09edadab7d6.png" src="../_images/7a383254dd5518918dfec66d74275441e64561a99a530e4ceaedc09edadab7d6.png" />
</div>
</div>
</section>
</section>
<section id="build-spatial-knn-graph">
<h2>2. Build Spatial kNN Graph<a class="headerlink" href="#build-spatial-knn-graph" title="Link to this heading"></a></h2>
<p>We compute a <em>k</em>-nearest-neighbour graph directly from the (<em>x</em>, <em>y</em>)
coordinates.  The graph is stored in <code class="docutils literal notranslate"><span class="pre">ad.obsp[&quot;connectivities&quot;]</span></code> and is used
by <code class="docutils literal notranslate"><span class="pre">nf.aggregate_neighbors</span></code> to collect neighbourhood compositions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;spatial&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connectivities shape:&quot;</span><span class="p">,</span> <span class="n">ad</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;connectivities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>connectivities shape: (1200, 1200)
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregate-neighbourhood-compositions">
<h2>3. Aggregate Neighbourhood Compositions<a class="headerlink" href="#aggregate-neighbourhood-compositions" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">nf.aggregate_neighbors</span></code> builds a <em>cell-type × cell-type</em> co-occurrence
matrix by summing the label vectors of all kNN neighbours for every
cell, and then stacking those sums across cells.</p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">scale=&quot;expected&quot;</span></code> divides each entry by the value expected under
random rewiring (i.e. proportional to marginal cell-type abundances), so the
matrix highlights cell-type pairs that are spatially enriched relative to a
random baseline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agg_prob</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">aggregate_neighbors</span><span class="p">(</span>
    <span class="n">spatial</span><span class="o">=</span><span class="n">ad</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;expected&quot;</span><span class="p">,</span>   <span class="c1"># divide by random-rewiring baseline</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;agg_prob shape:&quot;</span><span class="p">,</span> <span class="n">agg_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">agg_prob</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>agg_prob shape: (6, 6)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>T0</th>
      <th>T1</th>
      <th>T2</th>
      <th>T3</th>
      <th>T4</th>
      <th>T5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T0</th>
      <td>1.022265</td>
      <td>0.932342</td>
      <td>2.120123</td>
      <td>0.488750</td>
      <td>0.951223</td>
      <td>0.454788</td>
    </tr>
    <tr>
      <th>T1</th>
      <td>0.932342</td>
      <td>1.399956</td>
      <td>0.970566</td>
      <td>0.582617</td>
      <td>1.507932</td>
      <td>0.566799</td>
    </tr>
    <tr>
      <th>T2</th>
      <td>2.120123</td>
      <td>0.970566</td>
      <td>0.982400</td>
      <td>0.414062</td>
      <td>0.974337</td>
      <td>0.494591</td>
    </tr>
    <tr>
      <th>T3</th>
      <td>0.488750</td>
      <td>0.582617</td>
      <td>0.414062</td>
      <td>1.204561</td>
      <td>0.477976</td>
      <td>2.903270</td>
    </tr>
    <tr>
      <th>T4</th>
      <td>0.951223</td>
      <td>1.507932</td>
      <td>0.974337</td>
      <td>0.477976</td>
      <td>1.429635</td>
      <td>0.615443</td>
    </tr>
    <tr>
      <th>T5</th>
      <td>0.454788</td>
      <td>0.566799</td>
      <td>0.494591</td>
      <td>2.903270</td>
      <td>0.615443</td>
      <td>1.058036</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">agg_prob</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Aggregated neighbourhood compositions (scaled)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.02, &#39;Aggregated neighbourhood compositions (scaled)&#39;)
</pre></div>
</div>
<img alt="../_images/0e66fc7adfa0cf73f2dcb60efc366bd00875fe655ed4dfbb2d0551961e26a63a.png" src="../_images/0e66fc7adfa0cf73f2dcb60efc366bd00875fe655ed4dfbb2d0551961e26a63a.png" />
</div>
</div>
</section>
<section id="find-niches-nmf">
<h2>4. Find Niches (NMF)<a class="headerlink" href="#find-niches-nmf" title="Link to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">nf.find_niches</span></code> factorises the aggregated neighbour matrix using
Non-negative Matrix Factorisation (NMF): $A \approx W \cdot H$ and
then aggregate $W$ and $H$ into a single membership matrix $S$:
$S = 0.5 \cdot \hat{W} + 0.5 \cdot \hat{H}^T$.</p>
<p>where</p>
<ul class="simple">
<li><p>$A$ — cell-type × cell-type co-occurrence matrix (<code class="docutils literal notranslate"><span class="pre">agg_prob</span></code>)</p></li>
<li><p>$W$ — <em>membership</em> matrix (cell-types × niches): how much each cell type
contributes to each niche</p></li>
<li><p>$H$ — <em>features</em> matrix (niches × cell-types): the cell-type composition
characteristic of each niche</p></li>
</ul>
<p>Setting <code class="docutils literal notranslate"><span class="pre">n_clusters=None</span></code> lets the function select the optimal number of
niches automatically via the elbow of the reconstruction-error curve
(up to <code class="docutils literal notranslate"><span class="pre">max_clusters</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">find_niches</span><span class="p">(</span>
    <span class="n">agg_prob</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>          <span class="c1"># plot reconstruction-error elbow curve</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># auto-select via elbow</span>
    <span class="n">max_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">return_dataframes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected number of niches: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># symmetrize the factors into a single membership matrix</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">symmetrise_nmf_factors</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
<span class="n">niche_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;niche_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">niche_names</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Membership matrix (cell-types x niches):&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Niche summary (cell-type x niche)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a652bf59c5b682c4dcded16d04fd622cc8756774e6aefd9b37cfad2d062fda58.png" src="../_images/a652bf59c5b682c4dcded16d04fd622cc8756774e6aefd9b37cfad2d062fda58.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selected number of niches: 5
Membership matrix (cell-types x niches):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>niche_0</th>
      <th>niche_1</th>
      <th>niche_2</th>
      <th>niche_3</th>
      <th>niche_4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>T0</th>
      <td>0.060609</td>
      <td>0.075909</td>
      <td>0.175061</td>
      <td>0.350498</td>
      <td>0.453779</td>
    </tr>
    <tr>
      <th>T1</th>
      <td>0.098380</td>
      <td>0.093964</td>
      <td>0.333980</td>
      <td>0.106475</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>T2</th>
      <td>0.061812</td>
      <td>0.069087</td>
      <td>0.150537</td>
      <td>0.419889</td>
      <td>0.396587</td>
    </tr>
    <tr>
      <th>T3</th>
      <td>0.346026</td>
      <td>0.321406</td>
      <td>0.000000</td>
      <td>0.011391</td>
      <td>0.080366</td>
    </tr>
    <tr>
      <th>T4</th>
      <td>0.093475</td>
      <td>0.087438</td>
      <td>0.340110</td>
      <td>0.110386</td>
      <td>0.000214</td>
    </tr>
    <tr>
      <th>T5</th>
      <td>0.339697</td>
      <td>0.352196</td>
      <td>0.000312</td>
      <td>0.001361</td>
      <td>0.069054</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.02, &#39;Niche summary (cell-type x niche)&#39;)
</pre></div>
</div>
<img alt="../_images/d76f65633942a6dcdaf898d4ceb7ca589217cdf545ccd4fa06fa36c9094b2a19.png" src="../_images/d76f65633942a6dcdaf898d4ceb7ca589217cdf545ccd4fa06fa36c9094b2a19.png" />
</div>
</div>
</section>
<section id="visualise-spatial-niches">
<h2>5. Visualise Spatial Niches<a class="headerlink" href="#visualise-spatial-niches" title="Link to this heading"></a></h2>
<section id="aggregated-interactions-niche-overlay">
<h3>Aggregated interactions + niche overlay<a class="headerlink" href="#aggregated-interactions-niche-overlay" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">nf.plot_aggregated_neighbors</span></code> combines the co-occurrence heatmap with the
niche loadings in a single view.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nf</span><span class="o">.</span><span class="n">plot_aggregated_neighbors</span><span class="p">(</span>
    <span class="n">agg_prob</span><span class="p">,</span>
    <span class="n">summary</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">colors_ratio</span><span class="o">=</span><span class="mf">0.035</span><span class="p">,</span>
    <span class="n">dendrogram_ratio</span><span class="o">=</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8213796a3f0130f78e6fce628268807e9e55d174704e3c658f071db032323f58.png" src="../_images/8213796a3f0130f78e6fce628268807e9e55d174704e3c658f071db032323f58.png" />
</div>
</div>
</section>
<section id="niche-bipartite-graph">
<h3>Niche bipartite graph<a class="headerlink" href="#niche-bipartite-graph" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">nf.plot_niches</span></code> displays the niche–cell-type associations as a bipartite
graph.  Edges connect each niche to the cell types with membership weights
above <code class="docutils literal notranslate"><span class="pre">threshold</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)}):</span>
    <span class="n">nf</span><span class="o">.</span><span class="n">plot_niches</span><span class="p">(</span>
        <span class="n">membership</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_width_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/787655cd8489d736af9000bdb5369b2e5d0c46afdd50ab0303b1e911bd522f8f.png" src="../_images/787655cd8489d736af9000bdb5369b2e5d0c46afdd50ab0303b1e911bd522f8f.png" />
</div>
</div>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>This tutorial walked through the core nichefinder workflow:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Step</p></th>
<th class="head"><p>Function / method</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Load data</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pd.read_csv</span></code> → <code class="docutils literal notranslate"><span class="pre">sc.AnnData</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Spatial kNN graph</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sc.pp.neighbors(...,</span> <span class="pre">use_rep=&quot;spatial&quot;)</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Aggregate neighbourhoods</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nf.aggregate_neighbors</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Discover niches (NMF)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nf.find_niches</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Visualise niche profiles</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">nf.plot_aggregated_neighbors</span></code>, <code class="docutils literal notranslate"><span class="pre">nf.plot_niches</span></code></p></td>
</tr>
</tbody>
</table>
<p><strong>Key parameters to tune:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_neighbors</span></code> — the spatial neighbourhood size</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scale</span></code> — how to normalise the co-occurrence matrix<br />
(<code class="docutils literal notranslate"><span class="pre">&quot;expected&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;expected_no_diag&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_clusters</span></code> / <code class="docutils literal notranslate"><span class="pre">max_clusters</span></code> — number of niches (or maximum for auto-selection)</p></li>
</ul>
<p>For real ISS data, replace the one-hot <code class="docutils literal notranslate"><span class="pre">cell_type_prob</span></code> matrix with
probabilistic label-transfer output from <code class="docutils literal notranslate"><span class="pre">nf.transfer_labels</span></code>.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p>[1] Agrawal, A., Thomann, S., Basu, S. et al. NiCo identifies extrinsic drivers of cell state modulation by niche covariation analysis. Nat Commun 15, 10628 (2024). https://doi.org/10.1038/s41467-024-54973-w</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="niche_score_mapping.html" class="btn btn-neutral float-right" title="nichefinder — Niche Score Mapping" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, J. Patrick Pett.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>