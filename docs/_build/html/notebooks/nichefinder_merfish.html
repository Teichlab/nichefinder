

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nichefinder - MERFISH data &mdash; nichefinder 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            nichefinder
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="example_simulated_data.html">nichefinder — Simulated Data Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="niche_score_mapping.html">nichefinder — Niche Score Mapping</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/gene_selection.html">Gene Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/label_transfer.html">Label Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/niche_analysis.html">Niche Analysis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nichefinder</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">nichefinder - MERFISH data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/nichefinder_merfish.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nichefinder-merfish-data">
<h1>nichefinder - MERFISH data<a class="headerlink" href="#nichefinder-merfish-data" title="Link to this heading"></a></h1>
<p>This notebook demonstrates the nichefinder analysis pipeline on the MERFISH mouse hypothalamic preoptic region dataset from <a class="reference external" href="https://doi.org/10.1126/science.aau5324">Moffitt et al., Science 2018</a>, loaded directly via squidpy. Label transfer is performed from a matched scRNA-seq mouse cortex reference dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">squidpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../..&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nichefinder</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nf</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</div>
<section id="load-data">
<h2>1. Load data<a class="headerlink" href="#load-data" title="Link to this heading"></a></h2>
<section id="spatial-merfish-mouse-hypothalamus">
<h3>Spatial: MERFISH mouse hypothalamus<a class="headerlink" href="#spatial-merfish-mouse-hypothalamus" title="Link to this heading"></a></h3>
<p>73,655 cells × 161 genes across multiple coronal slices. Cell type annotations are stored in <code class="docutils literal notranslate"><span class="pre">obs['Cell_class']</span></code> and slice identity in <code class="docutils literal notranslate"><span class="pre">obs['Bregma']</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_ad</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">merfish</span><span class="p">()</span>
<span class="n">spatial_ad</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 73655 × 161
    obs: &#39;Cell_ID&#39;, &#39;Animal_ID&#39;, &#39;Animal_sex&#39;, &#39;Behavior&#39;, &#39;Bregma&#39;, &#39;Centroid_X&#39;, &#39;Centroid_Y&#39;, &#39;Cell_class&#39;, &#39;Neuron_cluster_ID&#39;, &#39;batch&#39;
    uns: &#39;Cell_class_colors&#39;
    obsm: &#39;spatial&#39;, &#39;spatial3d&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Inspect available slices</span>
<span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Bregma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bregma
-14.0    6605
-29.0    6509
-19.0    6507
-24.0    6412
-9.0     6185
-4.0     6154
 6.0     6144
 1.0     6111
 16.0    6067
 11.0    5799
 26.0    5584
 21.0    5578
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Work on a single slice for interpretable 2D spatial analysis</span>
<span class="n">SLICE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">spatial_ad</span> <span class="o">=</span> <span class="n">spatial_ad</span><span class="p">[</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">Bregma</span> <span class="o">==</span> <span class="n">SLICE</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slice Bregma=</span><span class="si">{</span><span class="n">SLICE</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">n_obs</span><span class="si">}</span><span class="s2"> cells x </span><span class="si">{</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">n_vars</span><span class="si">}</span><span class="s2"> genes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slice Bregma=-9: 6185 cells x 161 genes
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">spatial_ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float32(0.0), np.float32(181.05391))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_cells</span><span class="p">(</span><span class="n">spatial_ad</span><span class="p">,</span> <span class="n">min_genes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">spatial_ad</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">spatial_ad</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">spatial_ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float32(0.0), np.float32(8.823538))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build spatial neighbor graph from 2D coordinates</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">spatial_ad</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;spatial&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="reference-scrna-seq-mouse-cortex">
<h3>Reference: scRNA-seq mouse cortex<a class="headerlink" href="#reference-scrna-seq-mouse-cortex" title="Link to this heading"></a></h3>
<p>Pre-processed scRNA-seq mouse cortex from Zeisel et al. 2018 (~3k cells, cell types in <code class="docutils literal notranslate"><span class="pre">obs['cell_type']</span></code>), used as reference for label transfer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">sc_mouse_cortex</span><span class="p">()</span>
<span class="n">ad</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 21697 × 36826
    obs: &#39;sample_name&#39;, &#39;organism&#39;, &#39;donor_sex&#39;, &#39;cell_class&#39;, &#39;cell_subclass&#39;, &#39;cell_cluster&#39;, &#39;n_genes_by_counts&#39;, &#39;log1p_n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;pct_counts_in_top_50_genes&#39;, &#39;pct_counts_in_top_100_genes&#39;, &#39;pct_counts_in_top_200_genes&#39;, &#39;pct_counts_in_top_500_genes&#39;, &#39;total_counts_mt&#39;, &#39;log1p_total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;n_counts&#39;
    var: &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;log1p_mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;log1p_total_counts&#39;, &#39;n_cells&#39;, &#39;highly_variable&#39;, &#39;highly_variable_rank&#39;, &#39;means&#39;, &#39;variances&#39;, &#39;variances_norm&#39;
    uns: &#39;cell_class_colors&#39;, &#39;cell_subclass_colors&#39;, &#39;hvg&#39;, &#39;neighbors&#39;, &#39;pca&#39;, &#39;umap&#39;
    obsm: &#39;X_pca&#39;, &#39;X_umap&#39;
    varm: &#39;PCs&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ad</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float32(0.0), np.float32(13.157556), np.float32(399744.0))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ad</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ad</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(np.float32(0.0), np.float32(8.002667), np.float32(8.002667))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cell_subclass
L5 IT         2952
Vip           2645
Sst           2534
L6 IT         2166
Pvalb         2065
Lamp5         1837
L4            1340
L6 CT         1220
L2/3 IT       1172
L5 PT          895
NP             733
Astro          545
L6b            457
Sncg           244
Oligo          185
Endo           155
VLMC           131
Macrophage     131
SMC            106
Serpinf1        84
Meis2           55
Peri            28
CR              17
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="gene-selection">
<h2>2. Gene selection<a class="headerlink" href="#gene-selection" title="Link to this heading"></a></h2>
<p>The MERFISH panel contains only 161 genes. We intersect these with the reference and select shared highly variable genes. Since the panel is already small, <code class="docutils literal notranslate"><span class="pre">min_disp</span></code> is relaxed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gene_sel</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">select_genes</span><span class="p">(</span>
    <span class="n">suspension</span><span class="o">=</span><span class="n">ad</span><span class="p">,</span>
    <span class="n">spatial</span><span class="o">=</span><span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">kind_susp</span><span class="o">=</span><span class="s2">&quot;hvg&quot;</span><span class="p">,</span>
    <span class="n">kind_spat</span><span class="o">=</span><span class="s2">&quot;hvg&quot;</span><span class="p">,</span>
    <span class="c1"># min_disp=0.01,</span>
    <span class="c1"># n_top_genes=500,</span>
    <span class="n">kwargs_susp</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_disp&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="n">kwargs_spat</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_disp&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_sel</span><span class="p">)</span><span class="si">}</span><span class="s2"> genes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:nichefinder.gene_selection:select 152 overlapping genes
INFO:nichefinder.gene_selection:select highly variable genes for suspension data
INFO:nichefinder.gene_selection:  &gt; number of HVG in suspension: 152
INFO:nichefinder.gene_selection:select highly variable genes for spatial data
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/legacy_api_wrap/__init__.py:88: UserWarning: `n_top_genes` &gt; number of normalized dispersions, returning all genes with normalized dispersions.
  return fn(*args_all, **kw)
INFO:nichefinder.gene_selection:  &gt; number of HVG in spatial: 151
INFO:nichefinder.gene_selection:number of selected genes: 151
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selected 151 genes
</pre></div>
</div>
</div>
</div>
</section>
<section id="label-transfer">
<h2>3. Label transfer<a class="headerlink" href="#label-transfer" title="Link to this heading"></a></h2>
<p>Transfer cell type labels from the scRNA-seq reference to the MERFISH spatial data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_ad</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">transfer_labels</span><span class="p">(</span>
    <span class="n">suspension</span><span class="o">=</span><span class="n">ad</span><span class="p">,</span>
    <span class="n">spatial</span><span class="o">=</span><span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">genes</span><span class="o">=</span><span class="n">gene_sel</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">,</span>
    <span class="n">train_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">),</span>
    <span class="n">predict_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:nichefinder.label_transfer:subsetting to 152 genes
INFO:nichefinder.label_transfer:training logistic regression model for cell_subclass
INFO:nichefinder.label_transfer:predicting labels for cell_subclass
INFO:nichefinder.label_transfer:152 features used for prediction
INFO:nichefinder.label_transfer:compiling results
INFO:nichefinder.label_transfer:adding predicted labels for cell_subclass to spatial dataset
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nf</span><span class="o">.</span><span class="n">add_prob_to_obs</span><span class="p">(</span><span class="n">spatial_ad</span><span class="p">,</span> <span class="s2">&quot;cell_subclass&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 6185 × 161
    obs: &#39;Cell_ID&#39;, &#39;Animal_ID&#39;, &#39;Animal_sex&#39;, &#39;Behavior&#39;, &#39;Bregma&#39;, &#39;Centroid_X&#39;, &#39;Centroid_Y&#39;, &#39;Cell_class&#39;, &#39;Neuron_cluster_ID&#39;, &#39;batch&#39;, &#39;n_genes&#39;, &#39;cell_subclass&#39;, &#39;Astro_x&#39;, &#39;CR_x&#39;, &#39;Endo_x&#39;, &#39;L2/3 IT_x&#39;, &#39;L4_x&#39;, &#39;L5 IT_x&#39;, &#39;L5 PT_x&#39;, &#39;L6 CT_x&#39;, &#39;L6 IT_x&#39;, &#39;L6b_x&#39;, &#39;Lamp5_x&#39;, &#39;Macrophage_x&#39;, &#39;Meis2_x&#39;, &#39;NP_x&#39;, &#39;Oligo_x&#39;, &#39;Peri_x&#39;, &#39;Pvalb_x&#39;, &#39;SMC_x&#39;, &#39;Serpinf1_x&#39;, &#39;Sncg_x&#39;, &#39;Sst_x&#39;, &#39;VLMC_x&#39;, &#39;Vip_x&#39;, &#39;Astro_y&#39;, &#39;CR_y&#39;, &#39;Endo_y&#39;, &#39;L2/3 IT_y&#39;, &#39;L4_y&#39;, &#39;L5 IT_y&#39;, &#39;L5 PT_y&#39;, &#39;L6 CT_y&#39;, &#39;L6 IT_y&#39;, &#39;L6b_y&#39;, &#39;Lamp5_y&#39;, &#39;Macrophage_y&#39;, &#39;Meis2_y&#39;, &#39;NP_y&#39;, &#39;Oligo_y&#39;, &#39;Peri_y&#39;, &#39;Pvalb_y&#39;, &#39;SMC_y&#39;, &#39;Serpinf1_y&#39;, &#39;Sncg_y&#39;, &#39;Sst_y&#39;, &#39;VLMC_y&#39;, &#39;Vip_y&#39;, &#39;Astro&#39;, &#39;CR&#39;, &#39;Endo&#39;, &#39;L2/3 IT&#39;, &#39;L4&#39;, &#39;L5 IT&#39;, &#39;L5 PT&#39;, &#39;L6 CT&#39;, &#39;L6 IT&#39;, &#39;L6b&#39;, &#39;Lamp5&#39;, &#39;Macrophage&#39;, &#39;Meis2&#39;, &#39;NP&#39;, &#39;Oligo&#39;, &#39;Peri&#39;, &#39;Pvalb&#39;, &#39;SMC&#39;, &#39;Serpinf1&#39;, &#39;Sncg&#39;, &#39;Sst&#39;, &#39;VLMC&#39;, &#39;Vip&#39;
    uns: &#39;Cell_class_colors&#39;, &#39;log1p&#39;, &#39;neighbors&#39;, &#39;label_transfer&#39;, &#39;cell_subclass_colors&#39;
    obsm: &#39;spatial&#39;, &#39;spatial3d&#39;, &#39;cell_subclass_prob&#39;
    obsp: &#39;distances&#39;, &#39;connectivities&#39;
</pre></div>
</div>
</div>
</div>
<section id="plot-transferred-labels">
<h3>Plot transferred labels<a class="headerlink" href="#plot-transferred-labels" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>

<span class="n">sq</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_scatter</span><span class="p">(</span>
    <span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">default_28</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... storing &#39;cell_subclass&#39; as categorical
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Please specify a valid `library_id` or set it permanently in `adata.uns[&#39;spatial&#39;]`
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:982: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39;, &#39;norm&#39; will be ignored
  _cax = scatter(
</pre></div>
</div>
<img alt="../_images/bab3e5f9709313fe6fd43007322fcbe66af8a6e6e883346020cfda55b396d650.png" src="../_images/bab3e5f9709313fe6fd43007322fcbe66af8a6e6e883346020cfda55b396d650.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare against original MERFISH cell type annotations</span>
<span class="n">sq</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_scatter</span><span class="p">(</span>
    <span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;Cell_class&quot;</span><span class="p">,</span>
    <span class="c1"># groups=[&#39;Excitatory&#39;, &#39;Inhibitory&#39;],</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Please specify a valid `library_id` or set it permanently in `adata.uns[&#39;spatial&#39;]`
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:982: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39;, &#39;norm&#39; will be ignored
  _cax = scatter(
</pre></div>
</div>
<img alt="../_images/7c73b6d8d681a27290d12eeff080d13de448119a3766437c873c06c07cbbd401.png" src="../_images/7c73b6d8d681a27290d12eeff080d13de448119a3766437c873c06c07cbbd401.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crosstab between transferred cell_subclass and original Cell_class labels</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">],</span> <span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Cell_class&quot;</span><span class="p">])</span>
<span class="n">ct_norm_col</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">ct_norm_col</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Crosstab: transferred cell_subclass vs original Cell_class&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell_class&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3f3ddc37cc3b6b7415cddec0d7fac85420ce31ede98dce0d7c701f2f9f05c1d3.png" src="../_images/3f3ddc37cc3b6b7415cddec0d7fac85420ce31ede98dce0d7c701f2f9f05c1d3.png" />
</div>
</div>
</section>
</section>
<section id="niche-analysis">
<h2>4. Niche analysis<a class="headerlink" href="#niche-analysis" title="Link to this heading"></a></h2>
<section id="aggregate-neighborhoods">
<h3>Aggregate neighborhoods<a class="headerlink" href="#aggregate-neighborhoods" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agg_prob</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">aggregate_neighbors</span><span class="p">(</span>
    <span class="n">spatial</span><span class="o">=</span><span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">agg_prob</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.matrix.ClusterGrid at 0x1579e8390&gt;
</pre></div>
</div>
<img alt="../_images/524b4ae3b710a6f953bdc5bb6f20a60e6ba5799b5c1b3980470db93624649e66.png" src="../_images/524b4ae3b710a6f953bdc5bb6f20a60e6ba5799b5c1b3980470db93624649e66.png" />
</div>
</div>
</section>
<section id="find-niches">
<h3>Find niches<a class="headerlink" href="#find-niches" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">find_niches</span><span class="p">(</span>
    <span class="n">agg_prob</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">max_clusters</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">return_dataframes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected number of niches: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Symmetrize the factors into a single membership matrix</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">symmetrise_nmf_factors</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
<span class="n">niche_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;niche_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span>
<span class="n">membership</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">niche_names</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Membership matrix (cell-types x niches):&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">membership</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:nichefinder.niche_analysis:calculate reconstruction errors for 12 clusters
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/sklearn/decomposition/_nmf.py:1720: ConvergenceWarning: Maximum number of iterations 1000 reached. Increase it to improve convergence.
  warnings.warn(
INFO:nichefinder.niche_analysis:ploting reconstruction error
</pre></div>
</div>
<img alt="../_images/0d8725d81161571e0ed7bcec67ab79d77cdc471e025e8f3bff8b9d4154ec57b9.png" src="../_images/0d8725d81161571e0ed7bcec67ab79d77cdc471e025e8f3bff8b9d4154ec57b9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selected number of niches: 8
Membership matrix (cell-types x niches):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>niche_0</th>
      <th>niche_1</th>
      <th>niche_2</th>
      <th>niche_3</th>
      <th>niche_4</th>
      <th>niche_5</th>
      <th>niche_6</th>
      <th>niche_7</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Astro</th>
      <td>0.043973</td>
      <td>0.034090</td>
      <td>0.065950</td>
      <td>0.008828</td>
      <td>0.047919</td>
      <td>0.046835</td>
      <td>0.072028</td>
      <td>0.019460</td>
    </tr>
    <tr>
      <th>CR</th>
      <td>0.034824</td>
      <td>0.030268</td>
      <td>0.057178</td>
      <td>0.060141</td>
      <td>0.039511</td>
      <td>0.055282</td>
      <td>0.064755</td>
      <td>0.032090</td>
    </tr>
    <tr>
      <th>Endo</th>
      <td>0.052682</td>
      <td>0.045894</td>
      <td>0.059506</td>
      <td>0.018211</td>
      <td>0.024760</td>
      <td>0.069435</td>
      <td>0.022070</td>
      <td>0.041886</td>
    </tr>
    <tr>
      <th>L2/3 IT</th>
      <td>0.055750</td>
      <td>0.048684</td>
      <td>0.050462</td>
      <td>0.052226</td>
      <td>0.022936</td>
      <td>0.015435</td>
      <td>0.050377</td>
      <td>0.037320</td>
    </tr>
    <tr>
      <th>L4</th>
      <td>0.031626</td>
      <td>0.042971</td>
      <td>0.056254</td>
      <td>0.099102</td>
      <td>0.024671</td>
      <td>0.087969</td>
      <td>0.023797</td>
      <td>0.023357</td>
    </tr>
    <tr>
      <th>L5 IT</th>
      <td>0.025840</td>
      <td>0.089514</td>
      <td>0.033165</td>
      <td>0.035430</td>
      <td>0.037240</td>
      <td>0.029659</td>
      <td>0.045135</td>
      <td>0.035395</td>
    </tr>
    <tr>
      <th>L5 PT</th>
      <td>0.032453</td>
      <td>0.053544</td>
      <td>0.037678</td>
      <td>0.070854</td>
      <td>0.035592</td>
      <td>0.059077</td>
      <td>0.028798</td>
      <td>0.055932</td>
    </tr>
    <tr>
      <th>L6 CT</th>
      <td>0.054531</td>
      <td>0.004046</td>
      <td>0.096318</td>
      <td>0.015168</td>
      <td>0.037054</td>
      <td>0.015106</td>
      <td>0.111475</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>L6 IT</th>
      <td>0.067852</td>
      <td>0.029026</td>
      <td>0.017809</td>
      <td>0.083714</td>
      <td>0.077908</td>
      <td>0.008609</td>
      <td>0.023620</td>
      <td>0.004556</td>
    </tr>
    <tr>
      <th>L6b</th>
      <td>0.044909</td>
      <td>0.042357</td>
      <td>0.016680</td>
      <td>0.074574</td>
      <td>0.040588</td>
      <td>0.027793</td>
      <td>0.049895</td>
      <td>0.063447</td>
    </tr>
    <tr>
      <th>Lamp5</th>
      <td>0.036907</td>
      <td>0.068537</td>
      <td>0.004070</td>
      <td>0.043015</td>
      <td>0.037865</td>
      <td>0.027113</td>
      <td>0.050002</td>
      <td>0.080021</td>
    </tr>
    <tr>
      <th>Macrophage</th>
      <td>0.065129</td>
      <td>0.031418</td>
      <td>0.050022</td>
      <td>0.028813</td>
      <td>0.026784</td>
      <td>0.050450</td>
      <td>0.034325</td>
      <td>0.041477</td>
    </tr>
    <tr>
      <th>Meis2</th>
      <td>0.046776</td>
      <td>0.047595</td>
      <td>0.002154</td>
      <td>0.056113</td>
      <td>0.045136</td>
      <td>0.027347</td>
      <td>0.048484</td>
      <td>0.075519</td>
    </tr>
    <tr>
      <th>NP</th>
      <td>0.023225</td>
      <td>0.049065</td>
      <td>0.035903</td>
      <td>0.088371</td>
      <td>0.036254</td>
      <td>0.062007</td>
      <td>0.050833</td>
      <td>0.046278</td>
    </tr>
    <tr>
      <th>Oligo</th>
      <td>0.057851</td>
      <td>0.053405</td>
      <td>0.038716</td>
      <td>0.005260</td>
      <td>0.050380</td>
      <td>0.100441</td>
      <td>0.004769</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>Peri</th>
      <td>0.065976</td>
      <td>0.026808</td>
      <td>0.066230</td>
      <td>0.028019</td>
      <td>0.032295</td>
      <td>0.051142</td>
      <td>0.003900</td>
      <td>0.059392</td>
    </tr>
    <tr>
      <th>Pvalb</th>
      <td>0.029255</td>
      <td>0.032266</td>
      <td>0.031615</td>
      <td>0.009785</td>
      <td>0.065609</td>
      <td>0.080856</td>
      <td>0.074434</td>
      <td>0.038050</td>
    </tr>
    <tr>
      <th>SMC</th>
      <td>0.010375</td>
      <td>0.052906</td>
      <td>0.098157</td>
      <td>0.023041</td>
      <td>0.082706</td>
      <td>0.000000</td>
      <td>0.005747</td>
      <td>0.095955</td>
    </tr>
    <tr>
      <th>Serpinf1</th>
      <td>0.039844</td>
      <td>0.034059</td>
      <td>0.052240</td>
      <td>0.020205</td>
      <td>0.049669</td>
      <td>0.063756</td>
      <td>0.062826</td>
      <td>0.024312</td>
    </tr>
    <tr>
      <th>Sncg</th>
      <td>0.037420</td>
      <td>0.075300</td>
      <td>0.038521</td>
      <td>0.023164</td>
      <td>0.043955</td>
      <td>0.028138</td>
      <td>0.055452</td>
      <td>0.012600</td>
    </tr>
    <tr>
      <th>Sst</th>
      <td>0.053682</td>
      <td>0.057456</td>
      <td>0.002016</td>
      <td>0.058509</td>
      <td>0.028646</td>
      <td>0.010591</td>
      <td>0.040497</td>
      <td>0.086063</td>
    </tr>
    <tr>
      <th>VLMC</th>
      <td>0.048940</td>
      <td>0.015692</td>
      <td>0.072454</td>
      <td>0.032597</td>
      <td>0.073875</td>
      <td>0.020319</td>
      <td>0.038033</td>
      <td>0.040243</td>
    </tr>
    <tr>
      <th>Vip</th>
      <td>0.040180</td>
      <td>0.035097</td>
      <td>0.016901</td>
      <td>0.064862</td>
      <td>0.038649</td>
      <td>0.062641</td>
      <td>0.038748</td>
      <td>0.086645</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="plot-niches">
<h3>Plot niches<a class="headerlink" href="#plot-niches" title="Link to this heading"></a></h3>
<section id="niches-as-bipartite-graph">
<h4>Niches as bipartite graph<a class="headerlink" href="#niches-as-bipartite-graph" title="Link to this heading"></a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">)}):</span>
    <span class="n">nf</span><span class="o">.</span><span class="n">plot_niches</span><span class="p">(</span>
        <span class="n">membership</span><span class="o">=</span><span class="n">membership</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.045</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_width_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0584a64745f051ccc087be3a95b011c2f3220eace098a2c928bae7f9616f71c0.png" src="../_images/0584a64745f051ccc087be3a95b011c2f3220eace098a2c928bae7f9616f71c0.png" />
</div>
</div>
</section>
<section id="niches-as-heatmap">
<h4>Niches as heatmap<a class="headerlink" href="#niches-as-heatmap" title="Link to this heading"></a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">membership</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.matrix.ClusterGrid at 0x48557b1d0&gt;
</pre></div>
</div>
<img alt="../_images/be03505dcc7efd2cd05d365dccab27fa04fade6bb8e98e6a8be600634b9e0d35.png" src="../_images/be03505dcc7efd2cd05d365dccab27fa04fade6bb8e98e6a8be600634b9e0d35.png" />
</div>
</div>
</section>
<section id="niches-next-to-clustered-aggregated-neighbor-matrix">
<h4>Niches next to clustered aggregated neighbor matrix<a class="headerlink" href="#niches-next-to-clustered-aggregated-neighbor-matrix" title="Link to this heading"></a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nf</span><span class="o">.</span><span class="n">plot_aggregated_neighbors</span><span class="p">(</span>
    <span class="n">agg_prob</span><span class="p">,</span>
    <span class="n">membership</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
    <span class="n">colors_ratio</span><span class="o">=</span><span class="mf">0.0125</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5a108b3d6fd83b5edc7b50ba3b539efa1980467e12278d3caeec63300ab872ff.png" src="../_images/5a108b3d6fd83b5edc7b50ba3b539efa1980467e12278d3caeec63300ab872ff.png" />
</div>
</div>
</section>
</section>
<section id="map-niches-back-to-cells">
<h3>Map niches back to cells<a class="headerlink" href="#map-niches-back-to-cells" title="Link to this heading"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">niche_names</span><span class="p">)</span>
<span class="n">H_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">niche_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">scores</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">cell_niche_scores</span><span class="p">(</span>
    <span class="n">adjacency</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;connectivities&quot;</span><span class="p">],</span>
    <span class="n">L</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;label_transfer&quot;</span><span class="p">][</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">][</span><span class="s2">&quot;obsm_key&quot;</span><span class="p">]],</span>
    <span class="n">W</span><span class="o">=</span><span class="n">W_df</span><span class="p">,</span>
    <span class="n">H</span><span class="o">=</span><span class="n">H_df</span><span class="p">,</span>
    <span class="n">cell_index</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;geometric&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;niche_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span>
<span class="n">scores</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>niche_0</th>
      <th>niche_1</th>
      <th>niche_2</th>
      <th>niche_3</th>
      <th>niche_4</th>
      <th>niche_5</th>
      <th>niche_6</th>
      <th>niche_7</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>41437-4</th>
      <td>0.019729</td>
      <td>0.015632</td>
      <td>0.022263</td>
      <td>0.009582</td>
      <td>0.016609</td>
      <td>0.017410</td>
      <td>0.016189</td>
      <td>0.011530</td>
    </tr>
    <tr>
      <th>41438-4</th>
      <td>0.026666</td>
      <td>0.028117</td>
      <td>0.023192</td>
      <td>0.020128</td>
      <td>0.023663</td>
      <td>0.019958</td>
      <td>0.026116</td>
      <td>0.023472</td>
    </tr>
    <tr>
      <th>41439-4</th>
      <td>0.022908</td>
      <td>0.019725</td>
      <td>0.027485</td>
      <td>0.012814</td>
      <td>0.021417</td>
      <td>0.019654</td>
      <td>0.021761</td>
      <td>0.016132</td>
    </tr>
    <tr>
      <th>41440-4</th>
      <td>0.020192</td>
      <td>0.014820</td>
      <td>0.022544</td>
      <td>0.010164</td>
      <td>0.015807</td>
      <td>0.016242</td>
      <td>0.017091</td>
      <td>0.013748</td>
    </tr>
    <tr>
      <th>41441-4</th>
      <td>0.026867</td>
      <td>0.024737</td>
      <td>0.028593</td>
      <td>0.017705</td>
      <td>0.023250</td>
      <td>0.020283</td>
      <td>0.024538</td>
      <td>0.021277</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize per-cell niche scores spatially</span>
<span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">niche_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span>

<span class="n">sq</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_scatter</span><span class="p">(</span>
    <span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">niche_names</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Please specify a valid `library_id` or set it permanently in `adata.uns[&#39;spatial&#39;]`
</pre></div>
</div>
<img alt="../_images/4e891d989cab56ef87d689cf475b741ab434ba7a43ae1dac75a29272a8605285.png" src="../_images/4e891d989cab56ef87d689cf475b741ab434ba7a43ae1dac75a29272a8605285.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">W_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">niche_names</span><span class="p">)</span>
<span class="n">H_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">niche_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">agg_prob</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">scores</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">cell_niche_scores</span><span class="p">(</span>
    <span class="n">adjacency</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;connectivities&quot;</span><span class="p">],</span>
    <span class="n">L</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;label_transfer&quot;</span><span class="p">][</span><span class="s2">&quot;cell_subclass&quot;</span><span class="p">][</span><span class="s2">&quot;obsm_key&quot;</span><span class="p">]],</span>
    <span class="n">W</span><span class="o">=</span><span class="n">W_df</span><span class="p">,</span>
    <span class="n">H</span><span class="o">=</span><span class="n">H_df</span><span class="p">,</span>
    <span class="n">cell_index</span><span class="o">=</span><span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;geometric&quot;</span><span class="p">,</span>
    <span class="n">s_sharpen</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
    <span class="n">n_smooth_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">spatial_ad</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;niche_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span>
<span class="n">spatial_ad</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;niche_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">niche_label</span>
<span class="n">scores</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>niche_0</th>
      <th>niche_1</th>
      <th>niche_2</th>
      <th>niche_3</th>
      <th>niche_4</th>
      <th>niche_5</th>
      <th>niche_6</th>
      <th>niche_7</th>
      <th>niche_label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>41437-4</th>
      <td>0.025951</td>
      <td>0.016062</td>
      <td>0.023503</td>
      <td>0.005898</td>
      <td>0.016042</td>
      <td>0.017652</td>
      <td>0.019389</td>
      <td>0.008349</td>
      <td>niche_0</td>
    </tr>
    <tr>
      <th>41438-4</th>
      <td>0.029097</td>
      <td>0.033581</td>
      <td>0.023283</td>
      <td>0.014678</td>
      <td>0.020675</td>
      <td>0.017134</td>
      <td>0.026551</td>
      <td>0.024861</td>
      <td>niche_1</td>
    </tr>
    <tr>
      <th>41439-4</th>
      <td>0.025514</td>
      <td>0.021296</td>
      <td>0.032810</td>
      <td>0.007889</td>
      <td>0.022078</td>
      <td>0.018242</td>
      <td>0.026964</td>
      <td>0.013423</td>
      <td>niche_2</td>
    </tr>
    <tr>
      <th>41440-4</th>
      <td>0.025988</td>
      <td>0.012322</td>
      <td>0.028648</td>
      <td>0.006140</td>
      <td>0.013724</td>
      <td>0.014324</td>
      <td>0.025625</td>
      <td>0.011535</td>
      <td>niche_2</td>
    </tr>
    <tr>
      <th>41441-4</th>
      <td>0.031986</td>
      <td>0.027567</td>
      <td>0.033136</td>
      <td>0.012440</td>
      <td>0.021976</td>
      <td>0.015878</td>
      <td>0.027419</td>
      <td>0.020077</td>
      <td>niche_2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sq</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial_scatter</span><span class="p">(</span>
    <span class="n">spatial_ad</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;niche_label&quot;</span><span class="p">,</span>
    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">palettes</span><span class="o">.</span><span class="n">default_28</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... storing &#39;niche_label&#39; as categorical
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: Please specify a valid `library_id` or set it permanently in `adata.uns[&#39;spatial&#39;]`
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/janpatrickpett/miniforge3/envs/nichefinder/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:982: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39;, &#39;norm&#39; will be ignored
  _cax = scatter(
</pre></div>
</div>
<img alt="../_images/578532df276954392b29b62ffe05ef84d79160f3f95207f1d23909752be2844f.png" src="../_images/578532df276954392b29b62ffe05ef84d79160f3f95207f1d23909752be2844f.png" />
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, J. Patrick Pett.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>